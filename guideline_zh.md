## 科研项目需求文档 (上下文文档)

**项目名称：** 基于Transition Matching (DTM) 的TTS模型推理加速适配
**项目目标：** 将现有的预训练 DiT-TTS 模型适配到 DTM 框架，通过训练轻量级 MLP Head 实现推理加速（降低 NFE），目标是在保持音质的前提下将推理步数从 32 降低至 4-8 步。

#### 1\. 现有模型架构 (基础模型上下文)

  * **骨干网络:** 扩散 Transformer (DiT)。
      * 配置：22 层, 16 个头, 隐藏层大小 = 1024。
      * 参数量：335.8M。
      * **状态：已在大规模野外数据集上充分训练，权重将完全冻结 (Frozen)。**
  * **输入数据:** Mel 频谱图 (80 个频段)。
  * **条件注入:** Cross-Attention (文本) + AdaLN (时间步/说话人)。
  * **现有推理:** Euler 求解器, 32 步, CFG = 2.0。
  * 注意：f5_tts 中的 scripts、runtime、eval 在这一阶段完全无需考虑

### 理论分析
### 核心数学假设 (物理原理)
* **全局路径 (全局路径):** 数据从纯噪声 $X_0$ 到真实数据 $X_T$ 的变化遵循线性插值（条件最优传输）：
    $$X_t = (1 - \frac{t}{T})X_0 + \frac{t}{T}X_T$$
    其中 $t$ 是离散的大时间步，$t \in \{0, 1, ..., T\}$。
* **预测目标 (目标):** 模型需要预测从起点到终点的总位移向量：
    $$Y = X_T - X_0$$

### 架构设计：解耦机制 (解耦)**
系统分为两部分：
* **骨干网络 ($f^\theta$, 冻结):** 你的 DiT 模型。
    * **输入:** 全局状态 $X_t$ 和全局时间 $t$。
    * **输出:** 特征序列 $h_t$。
    * **频率:** 低频运行（仅在整数 $t$ 时运行）。
* **流头 ($g^\theta$, 可训练):** 一个轻量级 MLP。
    * **输入:** 骨干网络特征 $h_t$ + 当前流状态 $y_s$ + 微观时间 $s$。
    * **输出:** 速度场 $u$（即对 $Y$ 的预测）。
    * **频率:** 高频运行（在 ODE 求解器内部运行）。

### 训练流程 (算法 3 实现要点)**
对于每一个批次：
1.  **采样:**
    * 随机采样真实数据 $X_T$ (Mel 频谱图)。
    * 随机采样噪声 $X_0 \sim \mathcal{N}(0, I)$。
    * 随机采样离散时间步 $t \sim \text{Uniform}(\{1, ..., T-1\})$。
2.  **准备骨干网络输入:**
    * 计算 $X_t = (1 - \frac{t}{T})X_0 + \frac{t}{T}X_T$。
    * **[前向传递 1]**: 将 $X_t$ 输入**冻结的**骨干网络，提取特征 $h_t$。
3.  **准备头部输入 (条件流匹配):**
    * 计算目标 $Y = X_T - X_0$。
    * 随机采样微观时间 $s \sim \text{Uniform}([0, 1])$。
    * 随机采样微观噪声 $Y_{noise} \sim \mathcal{N}(0, I)$。
    * 计算头部的输入状态 $Y_s = (1-s)Y_{noise} + sY$。
4.  **计算损失:**
    * **[前向传递 2]**: 将 $h_t, Y_s, s$ 输入可训练的 MLP 头部。
    * 得到预测输出 $\hat{v}$。
    * 计算 MSE 损失: $\|\hat{v} - (Y - Y_{noise})\|^2$。
    * *注意：TTS 任务需应用填充掩码，忽略填充部分的损失。*

### 推理流程 (算法 4 实现要点)**
生成过程如下：
1.  初始化 $X_0 \sim \mathcal{N}(0, I)$。
2.  循环 $t$ 从 $0$ 到 $T-1$：
    * **骨干网络步骤:** 运行一次骨干网络 $f^\theta(X_t, t)$ 得到特征 $h_t$。
    * **头部步骤 (ODE 求解):** 使用 ODE 求解器 (如 Euler) 从 $s=0$ 积分到 $s=1$。
        * 求解对象是 $Y$。
        * 初始状态 $Y_{s=0} \sim \mathcal{N}(0, I)$。
        * 动力学方程：$dY_s/ds = g^\theta(Y_s, h_t, s)$。
        * 解出 $Y_{final} = Y_{s=1}$。
    * **更新步骤:** 更新全局状态 $X_{t+1} = X_t + \frac{1}{T}Y_{final}$。
3.  返回 $X_T$。

### 特定参数配置 (基于F5-TTS 模型)
* **骨干网络维度:** 1024 (冻结)。
* **头部配置:**
    * 输入投影: 1024 -> 512。
    * 主体: 6 层, 512 隐藏层维度。
    * 组件: AdaLN (用于注入时间 $s$) + 4x FFN 扩展。
* **数据:** Mel 频谱图 (80 维)。

### 4\. 工程约束 (约束)

* **资源限制:** 单卡 RTX 4090 (24GB)。
* **代码风格:** PyTorch。代码必须是**非侵入式 (Non-intrusive)** 的，即不修改原 DiT 代码，而是作为一个独立的 `nn.Module` 挂载。
* **数据流:** 必须支持可变长度序列 (因为是 TTS)，注意掩码的处理。
* 如果参数配置与原始F5-TTS代码不符，以原始F5-TTS代码为准